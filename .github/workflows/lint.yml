name: Lint

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check-changes:
    name: Check if lint needed
    runs-on: ubuntu-latest
    outputs:
      should_lint: ${{ steps.filter.outputs.should_lint }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check changed files
      id: filter
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          # Per push su main, lint sempre
          echo "should_lint=true" >> $GITHUB_OUTPUT
        else
          # Per PR, controlla i file modificati
          git fetch origin ${{ github.base_ref }}

          # Verifica se esiste merge base
          if ! git merge-base origin/${{ github.base_ref }} HEAD > /dev/null 2>&1; then
            # Nessuna merge base = nuova branch, esegui lint per sicurezza
            echo "should_lint=true" >> $GITHUB_OUTPUT
            echo "⚠️ Nuova branch senza merge base, lint per sicurezza"
            exit 0
          fi

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Lint se ci sono modifiche a file rilevanti e NON solo a static/
          if echo "$CHANGED_FILES" | grep -qE '\.(py|toml|yaml)$|\.github/workflows/lint\.yml|\.pre-commit-config\.yaml'; then
            if echo "$CHANGED_FILES" | grep -qv '^static/'; then
              echo "should_lint=true" >> $GITHUB_OUTPUT
              echo "✅ Rilevate modifiche che richiedono lint"
            else
              echo "should_lint=false" >> $GITHUB_OUTPUT
              echo "⏭️ Solo modifiche a static/, skip lint"
            fi
          else
            echo "should_lint=false" >> $GITHUB_OUTPUT
            echo "⏭️ Nessuna modifica rilevante, skip lint"
          fi
        fi

  lint:
    name: Lint (Ruff)
    needs: check-changes
    if: needs.check-changes.outputs.should_lint == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python 3.11
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Add uv to PATH
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Run Ruff format (check only)
      run: uv run ruff format --check --diff .

    - name: Run Ruff check
      run: uv run ruff check .

    - name: Lint summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "✅ All lint checks passed!"
        else
          echo "❌ Lint checks failed"
          echo "Run locally: 'ruff format .' and 'ruff check --fix .'"
          exit 1
        fi
