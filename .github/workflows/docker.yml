name: Docker Build

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  check-changes:
    name: Check if build needed
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.filter.outputs.should_build }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Check changed files
      id: filter
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          # Per push su main, build sempre
          echo "should_build=true" >> $GITHUB_OUTPUT
        else
          # Per PR, controlla i file modificati
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Build se ci sono modifiche a file rilevanti e NON solo a static/
          if echo "$CHANGED_FILES" | grep -qE '\.(py|toml)$|Dockerfile|docker-compose\.yml|\.github/workflows/docker\.yml'; then
            if echo "$CHANGED_FILES" | grep -qv '^static/'; then
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "✅ Rilevate modifiche che richiedono build Docker"
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "⏭️ Solo modifiche a static/, skip build"
            fi
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "⏭️ Nessuna modifica rilevante, skip build"
          fi
        fi

  build:
    name: Docker Build
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      run: docker compose build
      env:
        DOCKER_BUILDKIT: 1
        COMPOSE_DOCKER_CLI_BUILD: 1

    - name: Verify image created
      run: |
        if docker images | grep -q "octotracker"; then
          echo "✅ Docker image built successfully!"
        else
          echo "❌ Docker image build failed"
          exit 1
        fi

    - name: Test container starts (dry-run)
      run: |
        # Test che il container parta (senza token, fallirà ma verificherà sintassi)
        docker compose config --quiet && echo "✅ Docker Compose configuration valid"
