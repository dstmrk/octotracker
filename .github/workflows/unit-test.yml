name: Unit Tests

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check-changes:
    name: Check if tests needed
    runs-on: ubuntu-latest
    outputs:
      should_test: ${{ steps.filter.outputs.should_test }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check changed files
      id: filter
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          # Per push su main, test sempre
          echo "should_test=true" >> $GITHUB_OUTPUT
        else
          # Per PR, controlla i file modificati
          git fetch origin ${{ github.base_ref }}

          # Verifica se esiste merge base
          if ! git merge-base origin/${{ github.base_ref }} HEAD > /dev/null 2>&1; then
            # Nessuna merge base = nuova branch, esegui test per sicurezza
            echo "should_test=true" >> $GITHUB_OUTPUT
            echo "⚠️ Nuova branch senza merge base, test per sicurezza"
            exit 0
          fi

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Test se ci sono modifiche a file rilevanti e NON solo a static/
          if echo "$CHANGED_FILES" | grep -qE '\.(py|toml)$|tests/|\.github/workflows/unit-test\.yml'; then
            if echo "$CHANGED_FILES" | grep -qv '^static/'; then
              echo "should_test=true" >> $GITHUB_OUTPUT
              echo "✅ Rilevate modifiche che richiedono test"
            else
              echo "should_test=false" >> $GITHUB_OUTPUT
              echo "⏭️ Solo modifiche a static/, skip test"
            fi
          else
            echo "should_test=false" >> $GITHUB_OUTPUT
            echo "⏭️ Nessuna modifica rilevante, skip test"
          fi
        fi

  test:
    name: Unit Tests
    needs: check-changes
    if: needs.check-changes.outputs.should_test == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # SonarCloud needs full git history

    - name: Set up Python 3.11
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Add uv to PATH
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Run pytest with coverage
      run: uv run pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=term-missing

    - name: SonarCloud Scan
      # Skip SonarCloud for Dependabot PRs (secrets not available for security)
      if: github.actor != 'dependabot[bot]'
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
